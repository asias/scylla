#!/bin/sh
#
# Copyright 2016 ScyllaDB
#
# This file is part of Scylla.
#
# See the LICENSE.PROPRIETARY file in the top-level directory for licensing information.

if [ "`id -u`" -ne 0 ]; then
    echo "Requires root permission."
    exit 1
fi

if [ -f /usr/bin/node_exporter ] || [ -f /usr/bin/prometheus-node_exporter ]; then
    echo "node_exporter already installed"
    exit 1
fi

. /usr/lib/scylla/scylla_lib.sh

if is_gentoo_variant; then
    emerge -uq net-analyzer/prometheus-node_exporter
    if is_systemd; then
       echo "net-analyzer/prometheus-node_exporter does not install systemd service files, please fill a bug if you need them."
    else
        rc-update add prometheus-node_exporter default
        service prometheus-node_exporter start
    fi
else
    version=0.14.0
    dir=/usr/lib/scylla/Prometheus/node_exporter
    mkdir -p $dir
    cd $dir
    curl -L https://github.com/prometheus/node_exporter/releases/download/v$version/node_exporter-$version.linux-amd64.tar.gz -o $dir/node_exporter-$version.linux-amd64.tar.gz
    tar -xvzf $dir/node_exporter-$version.linux-amd64.tar.gz
    rm $dir/node_exporter-$version.linux-amd64.tar.gz
    ln -s $dir/node_exporter-$version.linux-amd64/node_exporter /usr/bin
    . /etc/os-release

     if is_systemd; then
        systemctl enable node-exporter
        systemctl start node-exporter
    else
        cat <<EOT >> /etc/init/node_exporter.conf
# Run node_exporter

start on startup

script
   /usr/bin/node_exporter
end script
EOT
        service node_exporter start
    fi
fi

printf "node_exporter successfully installed\n"
